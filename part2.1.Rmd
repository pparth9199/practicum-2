---
title: "R Notebook"
output: html_notebook
---

---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(RSQLite)
```

```{r}
fn <- "pubmed_sample.xml"
dbfn <- "pubmed.db"
```

```{r, include=FALSE}
DBcon <- dbConnect(RSQLite::SQLite(), dbfn)
dbExecute(DBcon, "PRAGMA foreign_keys = ON")
```

Drop tables
```{sql connection = "DBcon"}
drop table if exists articlePub;
```

```{sql connection = "DBcon"}
drop table if exists dimTime;
```

```{sql connection = "DBcon"}
drop table if exists dimJournalIssue;
```

```{sql connection = "DBcon"}
drop table if exists dimJournal;
```

```{sql connection = "DBcon"}
drop table if exists dimArticle;
```

```{sql connection = "DBcon"}
drop table if exists dimAuthorList;
```

```{sql connection = "DBcon"}
drop table if exists Author;
```

Create tables
```{sql connection = "DBcon"}
CREATE TABLE articlePub (
  PMID INTEGER,
  ISSN TEXT,
  tid INTEGER AUTO_INCREMENT,
  aggregate INTEGER,
  PRIMARY KEY (PMID, ISSN, tid),
  FOREIGN KEY (PMID) REFERENCES dimArticle(PMID),
  FOREIGN KEY (ISSN) REFERENCES dimJournal(ISSN),
  FOREIGN KEY (tid) REFERENCES dimTime(tid)
);
```


```{sql connection = "DBcon"}
CREATE TABLE dimTime (
  tid INTEGER PRIMARY KEY,
  Year INTEGER,
  Month TEXT,
  Quarter TEXT
);
```

```{sql connection = "DBcon"}
CREATE TABLE dimJournal (
  ISSN TEXT PRIMARY KEY,
  Title TEXT,
  ISOabbreviation TEXT
);
```

```{sql connection = "DBcon"}
CREATE TABLE dimArticle (
  PMID INTEGER PRIMARY KEY,
  ArticleTitle TEXT,
  ArticleDate DATE,
  Language TEXT,
  AuthorList_id INTEGER AUTO_INCREMENT,
  FOREIGN KEY (AuthorList_id) REFERENCES dimAuthorList(AuthorList_id)
);
```

```{sql connection = "DBcon"}
CREATE TABLE dimAuthorList (
  AuthorList_id INTEGER PRIMARY KEY,
  Author_id INTEGER,
  FOREIGN KEY (Author_id) REFERENCES dimAuthor(Author_id)
);
```

```{sql connection = "DBcon"}
CREATE TABLE author (
  Author_id INTEGER PRIMARY KEY,
  LastName TEXT,
  ForeName TEXT,
  Initial TEXT,
  Affiliation TEXT
);
```

# Loading Libraries
```{r warning=FALSE}
library(XML)
library(xslt)
```

# Load XML data to database
## Read XML file
```{r}
xmlPath <- "./pubmed_sample.xml"
xmlDoc = read_xml(xmlPath)
```

## Load dimJournal table
```{r}
# Extract Journal Data
xslPath = "./journal.xsl"
xslDoc = read_xml(xslPath,package="xslt")
journal_raw = xml_xslt(xmlDoc,xslDoc)
journals = unique(xmlToDataFrame(XML::xmlParse(journal_raw)))
dbWriteTable(DBcon,name = "dimJournal", value = journals, append = TRUE)
```





